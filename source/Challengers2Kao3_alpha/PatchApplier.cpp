#include <Challengers2Kao3_alpha/PatchApplier.h>
#include <Challengers2Kao3_alpha/WinApi.h>


////////////////////////////////////////////////////////////////
// Konstruktor klasy wstrzykuj¹cej patche
////////////////////////////////////////////////////////////////
CPatchApplier::CPatchApplier(const wchar_t* full_path)
: CFileOperator(INVALID_HANDLE_VALUE, false, INVALID_HANDLE_VALUE, true)
{
	Sciezka = full_path;
	Bufor = nullptr;
}


////////////////////////////////////////////////////////////////
// Dekonstruktor klasy wstrzykuj¹cej patche
////////////////////////////////////////////////////////////////
CPatchApplier::~CPatchApplier()
{
	if (nullptr != Bufor)
	{
		delete[](Bufor);
	}
}


////////////////////////////////////////////////////////////////
// Aplikuj wybrany kod assemblerowy itd.
////////////////////////////////////////////////////////////////
void CPatchApplier::aplikujKod(uint32_t offset, uint32_t rozmiar, const char* kod)
{
	SetFilePointer(Plik2, offset, 0, FILE_BEGIN);
	zapiszPlik((void*)kod, rozmiar);
}


////////////////////////////////////////////////////////////////
// Aplikuj common changes
////////////////////////////////////////////////////////////////
void CPatchApplier::aplikujCommonChanges()
{
	/**** Ró¿ne ****/
	{
		CWindow::zmienTekstOknaLadowania(L"Applying patch: [minor code changes]");

		// FS Raw
		aplikujKod(0x00006065, 0x01, "\x00");

		// Pomiñ dekodowanie "ELEPHANT2.INI", "LEVELS.INI", "ITEMS.INI"
		aplikujKod(0x00223FF9, 0x05, "\xE9\x91\x00\x00\x00");

		// Pomiñ sprawdzanie pliku "HOF.INI"
		aplikujKod(0x0000B626, 0x05, "\xEB\x03\x90\x90\x90");
		aplikujKod(0x00014B56, 0x05, "\xEB\x03\x90\x90\x90");

		// Pomiñ logo i film intro
		aplikujKod(0x0000EA77, 0x06, "\xE9\x20\x01\x00\x00\x90");

		// Opcja "Choose level"
		aplikujKod(0x0000B094, 0x01, "\x01");
	}

	/**** Widescreen ****/
	{
		CWindow::zmienTekstOknaLadowania(L"Applying patch: [Widescreen support]");

		// const ScreenX (796.444)
		aplikujKod(0x00298224, 0x03, "\x72\x1C\x47");

		// const ScreenX/2 (398.222)
		aplikujKod(0x0029EA54, 0x03, "\x72\x1C\xC7");

		// "eOrtho2D"
		aplikujKod(0x001E9211, 0x03, "\x72\x1C\x47");

		// "eTextWriter"
		aplikujKod(0x000F515D, 0x03, "\x72\x1C\x47");

		// "eTextWriterEx"
		aplikujKod(0x0029E7C0, 0x03, "\x72\x1C\x3B");

		// "ePowerBar"
		aplikujKod(0x0029E4F0, 0x07, "\x39\x8E\xE3\x38\x8E\xE3\x88");

		// "eRadar"
		aplikujKod(0x000CEB6C, 0x01, "\x4C");
		aplikujKod(0x000CE12A, 0x01, "\x4C");

		// "eTimeIndicator"
		aplikujKod(0x000C757D, 0x06, "\xB8\x00\x00\x34\x44\x90");

		// "eDisplayOneOf"
		aplikujKod(0x000CF689, 0x85, "\x8B\x46\x24\x3D\x00\x00\xDC\x43\x75\x05\xB8\x00\x00\x20\x44\x89\x41\x60\x8B\x7A\x04\x89\x79\x64\x8B\x52\x08\x89\x51\x68\xE8\x05\x69\xF6\xFF\x8B\x4E\x10\x8B\x56\x1C\x55\x52\x8B\x01\xFF\x50\x70\x8B\x4E\x10\x8B\x56\x14\x55\x52\x8B\x01\xFF\x50\x70\x8B\x4E\x10\x8B\x56\x18\x55\x52\x8B\x01\xFF\x50\x70\x8B\x46\x18\xB9\x08\x00\x00\x00\x8B\x78\x1C\x0B\xF9\x89\x78\x1C\x8B\x46\x14\x5F\x8B\x50\x1C\x0B\xD1\x89\x50\x1C\x8B\x76\x1C\x8B\x46\x1C\x0B\xC1\x8B\x4C\x24\x0C\x89\x46\x1C\x5E\x5D\x64\x89\x0D\x00\x00\x00\x00\x5B\x83\xC4\x0C\xC2\x08\x00");

		// "eAskYesNo"
		aplikujKod(0x0011F724, 0x03, "\x72\x1C\xC7");
		aplikujKod(0x0011F8C5, 0x03, "\x72\x1C\xC7");
		aplikujKod(0x0011F1F6, 0x04, "\x72\x9C\x30\x44");
		aplikujKod(0x0011F354, 0x04, "\x72\x9C\x30\x44");
		aplikujKod(0x0011F43E, 0x04, "\x72\x9C\x30\x44");

		// "eCinemaMode"
		aplikujKod(0x000F8CD5, 0x03, "\x72\x9C\x47");

		// "eCredits"
		aplikujKod(0x00120E72, 0x03, "\x72\x1C\xC7");
		aplikujKod(0x00120EA5, 0x03, "\x72\x1C\x47");
		aplikujKod(0x0012079F, 0x03, "\x72\x1C\x2B");

		// "eBinoculars"
		aplikujKod(0x00165704, 0x06, "\xE9\x12\x02\x00\x00\x90");
	
		// "ePadRot" ("menu/interfejs3/celownik.tga")
		aplikujKod(0x00174015, 0x03, "\x72\x1C\xC7");

		// "eMenu" (005ED440)
		aplikujKod(0x001ED505, 0x03, "\x72\x1C\x47");
		aplikujKod(0x001ED53E, 0x03, "\x72\x1C\x47");
		aplikujKod(0x001ED589, 0x03, "\x72\x1C\x47");
		aplikujKod(0x001ED627, 0x04, "\x72\xDC\x0E\x44");

		// "eKao2Gamelet" ("mp_waiting_for_server")
		aplikujKod(0x000570FE, 0x03, "\x72\x1C\x47");

		// "eFullScreenEffect"
		aplikujKod(0x000D8069, 0x03, "\x72\x1C\xC7");

		// "eUIRacing"
		aplikujKod(0x001F4C86, 0x04, "\x72\x9C\x17\x44");
		aplikujKod(0x001F34F6, 0x03, "\x72\x1C\xC7");

		// "misc/movies/kao.avi"
		aplikujKod(0x0008E29F, 0x03, "\x55\x55\x55");

		// [loading] Odwo³ania do "glOrtho()" z "eKao2Gamelet"
		aplikujKod(0x00013966, 0x03, "\x72\x1C\x47");
		aplikujKod(0x00013C91, 0x03, "\x72\x1C\x47");
		aplikujKod(0x00013F11, 0x03, "\x72\x1C\x47");

		// [loading] 1: Bitmap with PAK (BITMAP_1)
		aplikujKod(0x00013F65, 0x03, "\xEB\x43\x90");
		aplikujKod(0x00013FA8, 0x04, "\x90\x90\x31\xC9");
		aplikujKod(0x00013FAD, 0x03, "\x00\x00\x80");
		aplikujKod(0x00013FB2, 0x03, "\x00\x00\x80");
		aplikujKod(0x00013FBB, 0x03, "\x72\x1C\xC7");
		aplikujKod(0x00013FC0, 0x03, "\x72\x1C\x47");

		// [loading] 2a: Pominiêcie domyœlnego rysowania
		aplikujKod(0x000139DA, 0x05, "\xE9\xFD\x00\x00\x00"); // PUBLISHER
		aplikujKod(0x00013CE5, 0x05, "\xE9\xFD\x00\x00\x00"); // BITMAP_2
														  
		// [loading] 2b: Wspólne zmiany przy wyœwietlaniu bitmap
		aplikujKod(0x00013ADF, 0x01, "\x80"); // PUBLISHER
		aplikujKod(0x00013DEA, 0x01, "\x80"); // BITMAP_2
		aplikujKod(0x00013AEB, 0x03, "\x72\x1C\xC7"); // PUBLISHER
		aplikujKod(0x00013DF6, 0x03, "\x72\x1C\xC7"); // BITMAP_2
		aplikujKod(0x00013AF0, 0x03, "\x72\x1C\x47"); // PUBLISHER
		aplikujKod(0x00013DFB, 0x03, "\x72\x1C\x47"); // BITMAP_2

		// [loading] obrazek "KaoLoadingAnim"
		aplikujKod(0x00014061, 0x04, "\x72\x1C\x29\x44"); // BITMAP_1
	}

	/**** "port_common_cracks.txt" ****/
	{
		CWindow::zmienTekstOknaLadowania(L"Applying patch: [common code changes]");

		// "GameApplication.cpp" - funkcja "kao_tw.00409B30" ("user.ini")
		aplikujKod(0x00009B54, 0x03, "\xEB\x7A\x90");
		aplikujKod(0x00009BD0, 0x08, "\x89\xCB\x8B\x45\x08\x50\xEB\x08");

		// "glutAppMain.cpp" - zmieñ nazwê okna z "Kangurek Kao: Tajemnica Wulkanu" na "Kao Challengers"
		aplikujKod(0x002E1E42, 0x0E, "\x6F\x20\x43\x68\x61\x6C\x6C\x65\x6E\x67\x65\x72\x73\x00");

		// "GameApplication.cpp" - popraw sprawdzanie liczby graczy do "theMPGame"
		aplikujKod(0x00133D64, 0x02, "\x7C\x05");

		// "eMusicManager"
		aplikujKod(0x0006FD85, 0x06, "\xEB\x0D\x90\x90\x90\x90");
		aplikujKod(0x0006F591, 0x06, "\x8B\x7C\xE4\x0C\xEB\x46");

		// "eLang" & gadget "eSnd"
		aplikujKod(0x0000ACC8, 0x07, "\xA1\xFC\xF1\x75\x00\xEB\x20");
		aplikujKod(0x00083E4B, 0x45, "\x8D\x54\xE4\x0C\x68\xFC\xF1\x75\x00\x68\x4C\xBD\x6E\x00\x52\xE8\xC1\x7A\xFA\xFF\x83\xC4\x0C\x89\xC1\x8B\x46\x08\x83\xC0\x12\x8D\x54\xE4\x08\x50\x52\xE8\xAB\x79\xFA\xFF\x8D\x4C\xE4\x0C\xE8\xD2\x76\xFA\xFF\x8D\x7E\x08\x89\xF9\xE8\xC8\x76\xFA\xFF\x8B\x44\xE4\x08\x89\x07\xEB\x1B");

		// @@@ Ekrany ³adowania poziomów
		aplikujKod(0x002DD138, 0x0D, "\x2F\x6C\x6F\x61\x64\x69\x6E\x67\x2E\x62\x6D\x70\x00");
		aplikujKod(0x0000C666, 0x04, "\xE9\x57\x02\x00");
		aplikujKod(0x0000C8B4, 0x06, "\xE9\xB0\x01\x00\x00\x90");
		aplikujKod(0x0000C8C2, 0x3A, "\x83\xEC\x04\x89\xE1\x8D\x44\xE4\x28\x50\x68\xBC\x38\x6E\x00\x51\xE8\x49\xF0\x01\x00\x83\xC4\x0C\x89\xC1\x68\x38\xD1\x6D\x00\x8D\x44\xE4\x08\x50\xE8\x35\xEF\x01\x00\x89\xE1\xE8\x5E\xEC\x01\x00\x83\xC4\x04\xE9\x76\xFD\xFF\xFF\x90\x90");

		// @@@ Inne przydatne hacki w Menu G³ównym
		aplikujKod(0x0000DC25, 0x06, "\xE9\xA0\x01\x00\x00\x90");
		aplikujKod(0x0000B0AB, 0x02, "\xC4\x42");

		// @@@ Pomiñ niepotrzebne pliki z Tajemnicy Wulkanu
		aplikujKod(0x0000C64A, 0x06, "\x83\xEC\x04\xEB\x11\x90");
		aplikujKod(0x0000CB91, 0x04, "\xE9\x1C\x01\x00");
		aplikujKod(0x001FF953, 0x02, "\x67\x02");
		aplikujKod(0x001EB4F8, 0x07, "\x8D\x44\xE4\x1C\xEB\x17\x90");
		aplikujKod(0x001EBE82, 0x09, "\xE9\xA8\x00\x00\x00\x90\x90\x90\x90");
		aplikujKod(0x001EBF2F, 0x07, "\xE9\x88\x00\x00\x00\x90\x90");
		aplikujKod(0x001EC049, 0x07, "\xE9\x88\x00\x00\x00\x90\x90");
		aplikujKod(0x001ED596, 0x0C, "\x83\xC4\x18\x6A\x00\x6A\x00\x89\xF9\xEB\x2B\x90");
		aplikujKod(0x001EC0D6, 0x06, "\xE9\x76\x01\x00\x00\x90");
		aplikujKod(0x001EC251, 0x07, "\xE9\xA0\x00\x00\x00\x90\x90");
		aplikujKod(0x001EC2F6, 0x07, "\xE9\x09\x01\x00\x00\x90\x90");
	}
}


////////////////////////////////////////////////////////////////
// Aplikuj now¹ ³atkê
////////////////////////////////////////////////////////////////
int CPatchApplier::aplikujLatke(int id)
{
	try
	{
		/* SprawdŸ plik docelowy, je¿eli nie by³ jeszcze otwierany */
		if (INVALID_HANDLE_VALUE == Plik2)
		{
			if (!otworzPlikDoZapisu(Sciezka.getText(), 1))
			{
				return 1;
			}

			CWindow::zmienTekstOknaLadowania(L"Verifying the file...");
			if (!testujPlikWykonywalny())
			{
				return 1;
			}
		}

		/* SprawdŸ, który patch zaaplikowaæ */
		switch (id)
		{
			/* "Kao Challengers: Single Player" */
			case 0x00:
			{
				aplikujCommonChanges();

				CWindow::zmienTekstOknaLadowania(L"Applying patch: [SinglePlayer code changes]");

				// Zmieñ nazwê g³ównego folderu
				aplikujKod(0x00072601, 0x02, "\x24\xA5");
				aplikujKod(0x00072641, 0x02, "\x24\xA5");
				aplikujKod(0x002EA524, 0x12, "\x2E\x2F\x63\x68\x61\x6C\x6C\x65\x6E\x67\x65\x72\x73\x5F\x73\x70\x2F\x00");

				// ERROR: "Class eSetCollisionFlags has duplicate feature 'const NO_COLLIDE'."
				aplikujKod(0x0021039E, 0x02, "\xEB\x0F");

				// "eSwietlikKao" (nieznana przyczyna b³êdu)
				aplikujKod(0x0010E6A2, 0x06, "\xE9\x06\x01\x00\x00\x90");

				// ERROR: "self shadowing problem."
				aplikujKod(0x0023265E, 0x06, "\xE9\x8F\x01\x00\x00\x90");

				// ERROR: "prop '%s.%s' already defined."
				aplikujKod(0x0020C83E, 0x02, "\xEB\x2D");

				// ERROR: "Class eBonusBieg has duplicate feature 'prop displaySpeedOnBar'."
				aplikujKod(0x001181C4, 0x02, "\xEB\x11");

				// "eNeckCtrl"
				aplikujKod(0x000F60EE, 0x02, "\xEB\x1A");
				aplikujKod(0x000F6B74, 0x05, "\xE9\x81\x01\x00\x00");

				// "ePowerUp" ("setBumerangs")
				aplikujKod(0x00140BFB, 0x05, "\xEB\x10\x90\x90\x90");
				aplikujKod(0x00140B71, 0x01, "\x98");

				// "ePowerUp" ("small_heart")
				aplikujKod(0x00140C5A, 0x05, "\x4E\x28\xEB\x15\x90");
				aplikujKod(0x00140C91, 0x06, "\x4E\x24\xEB\xDE\x90\x90");
				aplikujKod(0x00140C78, 0x01, "\x0A");

				// "eTransform" [EnergyIconXForm]
				aplikujKod(0x001E61A8, 0x05, "\xE4\x10\x00\x00\x20");
				aplikujKod(0x001E61B0, 0x05, "\xE4\x14\x00\x00\x20");
				
				// @@@ "eUI" MINI HACKS
				aplikujKod(0x001E7389, 0x26, "\xE8\xB2\x1B\x00\x00\x8D\x4C\xE4\x44\xE8\xB9\x41\xE4\xFF\xB8\x1C\x00\x00\x00\x89\x46\x30\x89\x46\x34\x8B\x46\x54\x39\xE8\x0F\x8E\xA8\x00\x00\x00\xEB\x09");
				aplikujKod(0x001E6DC9, 0x10, "\xC7\x38\x5E\x40\x75\x23\x39\xD8\x7E\x1F\x6A\x02\x89\xF1\xEB\x0B");
				aplikujKod(0x001E6DF2, 0x18, "\x8B\x46\x30\x89\xF1\x50\x57\xE8\xD2\x18\x00\x00\x5F\x5E\x5D\xB8\x01\x00\x00\x00\x5B\xC3\x90\x90");
				aplikujKod(0x001E6C25, 0x01, "\x04");
				aplikujKod(0x001E6C2E, 0x01, "\x04");
				aplikujKod(0x001E884A, 0x03, "\xEB\x7A\x90");
				aplikujKod(0x001E8A8E, 0x01, "\x68");
				aplikujKod(0x001E8A95, 0x01, "\x61");
				aplikujKod(0x001E8A9C, 0x01, "\x5A");
				aplikujKod(0x001E8AA5, 0x01, "\x51");
				aplikujKod(0x001E8AA7, 0x01, "\x06");
				aplikujKod(0x001E8AB0, 0x01, "\x04");
				aplikujKod(0x001E8AB8, 0x50, "\x6A\x02\x8B\xCE\xE8\x6F\xFD\xFF\xFF\x6A\x03\x8B\xCE\xE8\x66\xFD\xFF\xFF\x6A\x00\x8B\xCE\xE8\x1D\xD8\xFF\xFF\x6A\x02\x8B\xCE\xE8\x14\xD8\xFF\xFF\x6A\x03\x8B\xCE\xE8\x0B\xD8\xFF\xFF\x6A\x04\x8B\xCE\xE8\x02\xD8\xFF\xFF\x6A\x06\x8B\xCE\xE8\xF9\xD7\xFF\xFF\x6A\x00\xE8\x32\xE3\xE7\xFF\x83\xC4\x04\x5F\x5E\x5D\x59\xC2\x04\x00");

				// @@@ "eMenu" EXTRA HACK
				aplikujKod(0x001ECEE6, 0x0257, "\xB9\x68\xBE\x76\x00\xE8\x70\x57\xF4\xFF\x53\x55\x57\x8B\x7C\xE4\x78\x8B\x5C\xE4\x7C\x89\x5C\xE4\x44\x89\x5C\xE4\x54\xC7\x44\xE4\x2C\xAE\x47\x61\x3E\xC7\x44\xE4\x30\x7B\x14\xAE\x3E\xC7\x44\xE4\x34\x00\x00\x00\x3F\xB8\x00\x00\x80\x3F\x89\x44\xE4\x38\x89\x44\xE4\x3C\x89\x44\xE4\x40\x31\xC0\x3E\x89\x44\xE4\x48\x3E\x89\x44\xE4\x4C\x3E\x89\x44\xE4\x50\x8B\x86\xD0\x00\x00\x00\x8B\x68\x18\x3E\x8B\x45\x08\x8B\x40\x0C\x6A\x00\x50\x89\xF9\xE8\xF9\xD2\xE6\xFF\x8D\x44\xE4\x38\x53\x50\x68\x00\x00\x40\x42\x68\x00\x00\x40\x42\x68\x00\x00\x82\x42\x68\x00\x00\xC8\x42\xE8\x0A\x12\x04\x00\x83\xC4\x18\x3E\x8B\x45\x10\x8B\x40\x0C\x6A\x00\x50\x89\xF9\xE8\xC6\xD2\xE6\xFF\x8D\x44\xE4\x38\x53\x50\x68\x00\x00\x40\x42\x68\x00\x00\x40\x42\x68\x00\x00\x01\x43\x68\x00\x00\xC8\x42\xE8\xD7\x11\x04\x00\x83\xC4\x18\x8B\x45\x18\x8B\x40\x0C\x6A\x00\x50\x89\xF9\xE8\x94\xD2\xE6\xFF\x8D\x44\xE4\x38\x53\x50\x68\x00\x00\x40\x42\x68\x00\x00\x40\x42\x68\x00\x00\x41\x43\x68\x00\x00\xC8\x42\xE8\xA5\x11\x04\x00\x83\xC4\x18\xA1\x70\xBE\x76\x00\x8B\x0D\x80\xBE\x76\x00\x8B\x2C\x88\x8B\x46\x74\x6A\x00\x50\x89\xF9\xE8\x57\xD2\xE6\xFF\xD9\x44\xE4\x7C\xD8\x0D\x78\xB2\x69\x00\x51\xD9\x1C\xE4\x8D\x4C\xE4\x30\x51\x68\x00\x00\x48\x42\x68\x72\x1C\x4C\x44\x68\x00\x00\x70\x41\x68\x00\x00\x20\xC1\x57\xE8\x5A\xCA\xFF\xFF\x83\xC4\x1C\x8B\x4E\x74\x8D\x54\xE4\x48\x8D\x44\xE4\x38\x52\x50\x6A\x00\x68\x9A\x99\x19\x3F\x6A\x1A\x6A\x00\x8D\x55\x08\x52\xE8\x06\x44\x00\x00\x8B\x45\x34\x8B\x4D\x28\x51\x50\x68\x38\xA9\x6F\x00\x8D\x44\xE4\x20\x50\xE8\x9F\xF3\xE6\xFF\x83\xC4\x10\x8B\x4E\x74\x8D\x54\xE4\x48\x8D\x44\xE4\x38\x52\x50\x6A\x03\x68\x66\x66\xE6\x3E\x6A\x51\x68\x94\x00\x00\x00\x8D\x54\xE4\x2C\x52\xE8\xC7\x43\x00\x00\x8D\x4C\xE4\x14\xE8\x4E\xF2\xE6\xFF\x8B\x45\x38\x8B\x4D\x2C\x51\x50\x68\x38\xA9\x6F\x00\x8D\x44\xE4\x20\x50\xE8\x57\xF3\xE6\xFF\x83\xC4\x10\x8B\x4E\x74\x8D\x54\xE4\x48\x8D\x44\xE4\x38\x52\x50\x6A\x03\x68\x66\x66\xE6\x3E\x68\x91\x00\x00\x00\x68\x94\x00\x00\x00\x8D\x54\xE4\x2C\x52\xE8\x7C\x43\x00\x00\x8D\x4C\xE4\x14\xE8\x03\xF2\xE6\xFF\x8B\x45\x3C\x8B\x4D\x30\x51\x50\x68\x38\xA9\x6F\x00\x8D\x44\xE4\x20\x50\xE8\x0C\xF3\xE6\xFF\x83\xC4\x10\x8B\x4E\x74\x8D\x54\xE4\x48\x8D\x44\xE4\x38\x52\x50\x6A\x03\x68\x66\x66\xE6\x3E\x68\xD1\x00\x00\x00\x68\x94\x00\x00\x00\x8D\x54\xE4\x2C\x52\xE8\x31\x43\x00\x00\x8D\x4C\xE4\x14\xE8\xB8\xF1\xE6\xFF\x5F\x5D\x5B\x8B\x4C\xE4\x5C\x5E\x64\x89\x0D\x00\x00\x00\x00\x83\xC4\x64\xC2\x08\x00");

				// @@@ COMPUTE GAME PROGRESS (podczas zapisywania)
				aplikujKod(0x00003B90, 0xD4, "\x31\xC9\x51\x51\x51\x51\x51\x51\x51\x8B\x35\x70\xBE\x76\x00\x3B\x0D\x68\xBE\x76\x00\x7D\x39\x8B\x1C\x8E\x8A\x43\x20\x83\xE0\x01\x01\x04\xE4\x8B\x43\x28\x01\x44\xE4\x04\x8B\x43\x2C\x01\x44\xE4\x08\x8B\x43\x30\x01\x44\xE4\x0C\x8B\x43\x34\x01\x44\xE4\x10\x8B\x43\x38\x01\x44\xE4\x14\x8B\x43\x3C\x01\x44\xE4\x18\x41\xEB\xBF\xD9\x05\x4C\x3C\x40\x00\xDA\x0C\xE4\xDA\x35\x68\xBE\x76\x00\xD9\x05\x50\x3C\x40\x00\xDA\x4C\xE4\x10\xDA\x74\xE4\x04\xD9\x05\x54\x3C\x40\x00\xDA\x4C\xE4\x14\xDA\x74\xE4\x08\xD9\x05\x54\x3C\x40\x00\xDA\x4C\xE4\x18\xDA\x74\xE4\x0C\xD9\x05\x18\xBF\x76\x00\xD8\x1D\x5C\x3C\x40\x00\xDF\xE0\xF6\xC4\x40\x74\x08\xD9\x05\x58\x3C\x40\x00\xEB\x06\xD9\x05\x60\x3C\x40\x00\xDE\xC1\xDE\xC1\xDE\xC1\xDE\xC1\xDB\x1C\xE4\x8B\x04\xE4\x83\xC4\x1C\xC3\x00\x00\x34\x42\x00\x00\xA0\x41\x00\x00\x20\x41\x00\x00\xA0\x40\x00\x00\x80\x3F\x00\x00\x00\x00");

				// Opcja "Nowy wyœcig" tylko w poziomie "Wyœcig"
				aplikujKod(0x00013727, 0x01, "\x0D");

			} break;

			/* "Kao Challengers: Multi Player" */
			case 0x01:
			{
				aplikujCommonChanges();

				CWindow::zmienTekstOknaLadowania(L"Applying patch: [MultiPlayer code changes]");

				// Zmieñ nazwê g³ównego folderu
				aplikujKod(0x00072601, 0x02, "\x24\xA5");
				aplikujKod(0x00072641, 0x02, "\x24\xA5");
				aplikujKod(0x002EA524, 0x12, "\x2E\x2F\x63\x68\x61\x6C\x6C\x65\x6E\x67\x65\x72\x73\x5F\x6D\x70\x2F\x00");

				// Odczytywanie poziomów MultiPlayer ("mp_*") zamiast SinglePlayer
				aplikujKod(0x00131C41, 0x01, "\x86");

				// "theMPGame" (maksymalna liczba graczy)
				aplikujKod(0x00074005, 0x01, "\x04");

				// "eKao2Gamelet" (flaga "mp_start")
				aplikujKod(0x0000E2BE, 0x06, "\xE9\xE3\x02\x00\x00\x90");
				aplikujKod(0x0000BBF2, 0x06, "\xEB\x0E\x90\x90\x90\x90");
				aplikujKod(0x00011ECE, 0x06, "\xEB\x0E\x90\x90\x90\x90");
				aplikujKod(0x0000DB1D, 0x06, "\xEB\x0E\x90\x90\x90\x90");

				// "eUIRacingDataRevEng" (problem ze s³owem "owner")
				aplikujKod(0x002F9300, 0x22, "\x68\x6F\x6C\x64\x65\x72\x00\x00\x65\x55\x49\x52\x61\x63\x69\x6E\x67\x20\x68\x61\x73\x20\x6E\x6F\x74\x20\x62\x65\x65\x6E\x20\x73\x65\x74");
				aplikujKod(0x001C98E5, 0x02, "\x00\x93");
				aplikujKod(0x001C9B77, 0x02, "\x00\x93");
				aplikujKod(0x001C9A1A, 0x01, "\x08");

				// Zmniejszenie wielkoœci nicku gracza (lewa czeœæ ekranu)
				aplikujKod(0x001F82FA, 0x02, "\xC0\x3E");

				// @@@ "eMenu" EXTRA HACK
				aplikujKod(0x0000DB61, 0x07, "\x48\xA3\x80\xBE\x76\x00\xEB");
				aplikujKod(0x001ECEE6, 0xCE, "\x53\x55\x57\x8B\x7C\xE4\x78\x8B\x5C\xE4\x7C\x89\x5C\xE4\x44\x89\x5C\xE4\x54\xC7\x44\xE4\x2C\xAE\x47\x61\x3E\xC7\x44\xE4\x30\x7B\x14\xAE\x3E\xC7\x44\xE4\x34\x00\x00\x00\x3F\xB8\x00\x00\x80\x3F\x89\x44\xE4\x38\x89\x44\xE4\x3C\x89\x44\xE4\x40\x31\xC0\x3E\x89\x44\xE4\x48\x3E\x89\x44\xE4\x4C\x3E\x89\x44\xE4\x50\xA1\x7C\xBE\x76\x00\x8B\x0D\x80\xBE\x76\x00\x8B\x2C\x88\x8B\x46\x74\x6A\x00\x50\x89\xF9\xE8\x02\xD3\xE6\xFF\xD9\x44\xE4\x7C\xD8\x0D\x78\xB2\x69\x00\x51\xD9\x1C\xE4\x8D\x4C\xE4\x30\x51\x68\x00\x00\x48\x42\x68\x72\x1C\x4C\x44\x68\x00\x00\x70\x41\x68\x00\x00\x20\xC1\x57\xE8\x05\xCB\xFF\xFF\x83\xC4\x1C\x8B\x4E\x74\x8D\x54\xE4\x48\x8D\x44\xE4\x38\x52\x50\x6A\x00\x68\x9A\x99\x19\x3F\x6A\x1A\x6A\x00\x8D\x55\x08\x52\xE8\xB1\x44\x00\x00\x5F\x5D\x5B\x8B\x4C\xE4\x5C\x5E\x64\x89\x0D\x00\x00\x00\x00\x83\xC4\x64\xC2\x08\x00");

				// @@@ Schowaj wiêkszoœæ opcji w Menu G³ównym
				aplikujKod(0x000136ED, 0x2C, "\x30\xC0\x88\x86\x19\x17\x00\x00\x88\x86\xA5\x28\x00\x00\x88\x86\x5D\x28\x00\x00\x88\x86\x41\x16\x00\x00\x88\x86\x89\x16\x00\x00\x88\x86\xA0\x07\x00\x00\xE9\x60\x01\x00\x00\x90");

			} break;

			default:
			{
				throw EKomunikat(L"Wybrana ³atka nie jest jeszcze gotowa...\r\nNIE BIJCIE MNIE !!!");
				return 1;
			}
		}
	}
	catch (EKomunikat msg)
	{
		msg.pokazKomunikat(L"[Module: Patch Applier]\r\n\r\n");
		return 1;
	}

	return 0;
}


////////////////////////////////////////////////////////////////
// Testuj plik wykonywalny
////////////////////////////////////////////////////////////////
bool CPatchApplier::testujPlikWykonywalny()
{
	uint32_t crc = (-1);
	int i;
	int k;

	if (KAO3_FILESIZE != GetFileSize(Plik2, 0))
	{
		throw EKomunikat(L"Incorrect KAO3 executable file size! (should be 3,52 MB)");
		return false;
	}

	try
	{
		Bufor = new byte[KAO3_FILESIZE];
	}
	catch (std::bad_alloc)
	{
		Bufor = nullptr;
		throw EKomunikat(L"Unable to allocate memory for KAO3 executable!");
		return false;
	}

	Plik1 = Plik2;
	czytajPlik(Bufor, KAO3_FILESIZE);

	for (i = 0; i < KAO3_FILESIZE; i++)
	{
		crc ^= Bufor[i];

		for (k = 0; k < 8; k++)
		{
			crc = (1 & crc) ? ((crc >> 1) ^ CRC32_POLY) : (crc >> 1);
		}
	}

	if (KAO3_CRC32_CHECKSUM != (~crc))
	{
		throw EKomunikat(L"Incorrect KAO3 executable CRC-32 File Cheksum!");
		return false;
	}

	return true;
}
